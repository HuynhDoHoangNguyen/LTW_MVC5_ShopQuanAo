

/* ===========================================================
=========================================================== */
SET NOCOUNT ON;
SET DATEFORMAT DMY;
GO

/* ===========================================================
    RESET DATABASE
=========================================================== */
IF DB_ID('QL_ShopQuanAoNu') IS NOT NULL
    DROP DATABASE QL_ShopQuanAoNu;
GO

CREATE DATABASE QL_ShopQuanAoNu;
GO
USE QL_ShopQuanAoNu;
GO

/* ===========================================================
    SEQUENCE
=========================================================== */
CREATE SEQUENCE SEQ_NDM  START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_DM   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_SP   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_MAU  START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_SIZE START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_NCC  START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_PN   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_KH   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_DH   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_HINH START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_VT   START WITH 1 INCREMENT BY 1;
GO

/* ===========================================================
    PHÂN QUYỀN
=========================================================== */
CREATE TABLE VAI_TRO (
    MAVT VARCHAR(10) PRIMARY KEY
        DEFAULT ('VT' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_VT AS VARCHAR(10)), 2)),
    TENVAI NVARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE TAI_KHOAN (
    USERNAME VARCHAR(50) PRIMARY KEY,
    MATKHAU VARCHAR(200) NOT NULL,
    MAVT VARCHAR(10) NOT NULL,
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (MAVT) REFERENCES VAI_TRO(MAVT)
);

/* ===========================================================
    KHÁCH HÀNG (1-1 tài khoản)
=========================================================== */
CREATE TABLE KHACH_HANG (
    MAKH VARCHAR(10) PRIMARY KEY
        DEFAULT ('KH' + RIGHT('0000' + CAST(NEXT VALUE FOR SEQ_KH AS VARCHAR(10)), 4)),
    USERNAME VARCHAR(50) UNIQUE NOT NULL,  -- FK tới tài khoản
    HOTEN NVARCHAR(200) NOT NULL,
    SDT VARCHAR(15) UNIQUE NOT NULL,
    EMAIL NVARCHAR(200) UNIQUE NOT NULL,
    DIACHI NVARCHAR(200),
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (USERNAME) REFERENCES TAI_KHOAN(USERNAME)
);

/* ===========================================================
    NHÓM DANH MỤC -> DANH MỤC -> SẢN PHẨM
=========================================================== */
CREATE TABLE NHOM_DANH_MUC (
    MANHOM VARCHAR(10) PRIMARY KEY
        DEFAULT ('NDM' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_NDM AS VARCHAR(10)), 2)),
    TENNHOM NVARCHAR(100) UNIQUE NOT NULL,
    TRANGTHAI BIT DEFAULT 1
);

CREATE TABLE DANH_MUC (
    MADM VARCHAR(10) PRIMARY KEY
        DEFAULT ('DM' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_DM AS VARCHAR(10)), 2)),
    TENDM NVARCHAR(100) NOT NULL,
    MANHOM VARCHAR(10) NOT NULL,
    TRANGTHAI BIT DEFAULT 1,
    UNIQUE (TENDM, MANHOM),
    FOREIGN KEY (MANHOM) REFERENCES NHOM_DANH_MUC(MANHOM)
);

CREATE TABLE SAN_PHAM (
    MASP VARCHAR(10) PRIMARY KEY
        DEFAULT ('SP' + RIGHT('000' + CAST(NEXT VALUE FOR SEQ_SP AS VARCHAR(10)), 3)),
    TENSP NVARCHAR(200) UNIQUE NOT NULL,
    MADM VARCHAR(10) NOT NULL,
    MOTA NVARCHAR(MAX),
    SOLUONGTON INT DEFAULT 0,
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (MADM) REFERENCES DANH_MUC(MADM)
);

/* ===========================================================
    MÀU - SIZE - CHI TIẾT SP
=========================================================== */
CREATE TABLE MAU_SAC (
    MAMAU VARCHAR(10) PRIMARY KEY
        DEFAULT ('M' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_MAU AS VARCHAR(10)), 2)),
    TENMAU NVARCHAR(50) UNIQUE NOT NULL,
    TRANGTHAI BIT DEFAULT 1
);

CREATE TABLE KICH_THUOC (
    MASIZE VARCHAR(10) PRIMARY KEY
        DEFAULT ('SZ' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_SIZE AS VARCHAR(10)), 2)),
    TENSIZE NVARCHAR(20) UNIQUE NOT NULL,
    TRANGTHAI BIT DEFAULT 1
);

CREATE TABLE CHI_TIET_SP (
    MASP VARCHAR(10) NOT NULL,
    MAMAU VARCHAR(10) NOT NULL,
    MASIZE VARCHAR(10) NOT NULL,
    MACTSP AS (MASP + MAMAU + MASIZE) PERSISTED UNIQUE,
    SOLUONGTON INT DEFAULT 0 CHECK (SOLUONGTON >= 0),
    GIANHAP DECIMAL(18,3) NULL CHECK (GIANHAP IS NULL OR GIANHAP >= 0),
    GIABAN DECIMAL(18,3) NULL CHECK (GIABAN IS NULL OR GIABAN >= 0),
    TRANGTHAI BIT DEFAULT 1,
    PRIMARY KEY (MASP, MAMAU, MASIZE),
    FOREIGN KEY (MASP) REFERENCES SAN_PHAM(MASP),
    FOREIGN KEY (MAMAU) REFERENCES MAU_SAC(MAMAU),
    FOREIGN KEY (MASIZE) REFERENCES KICH_THUOC(MASIZE)
);

CREATE TABLE HINH_ANH_SP (
    MAHINH VARCHAR(10) PRIMARY KEY
        DEFAULT ('H' + RIGHT('000' + CAST(NEXT VALUE FOR SEQ_HINH AS VARCHAR(10)), 3)),
    MASP VARCHAR(10) NOT NULL,
    TENHINHANH NVARCHAR(200) NOT NULL,
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (MASP) REFERENCES SAN_PHAM(MASP)
);

/* ===========================================================
    NHÀ CUNG CẤP + NHẬP HÀNG
=========================================================== */
CREATE TABLE NHA_CUNG_CAP (
    MANCC VARCHAR(10) PRIMARY KEY
        DEFAULT ('NCC' + RIGHT('00' + CAST(NEXT VALUE FOR SEQ_NCC AS VARCHAR(10)), 2)),
    TENNCC NVARCHAR(200) NOT NULL,
    SDT VARCHAR(15),
    DIACHI NVARCHAR(200),
    TRANGTHAI BIT DEFAULT 1
);

CREATE TABLE PHIEU_NHAP (
    MAPN VARCHAR(10) PRIMARY KEY
        DEFAULT ('PN' + RIGHT('0000' + CAST(NEXT VALUE FOR SEQ_PN AS VARCHAR(10)), 4)),
    MANCC VARCHAR(10) NOT NULL,
    NGAYLAP DATE DEFAULT CAST(GETDATE() AS DATE),
    TONGSOLUONG INT DEFAULT 0,
    TONGTHANHTIEN DECIMAL(18,3) DEFAULT 0,
    GHICHU NVARCHAR(200),
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (MANCC) REFERENCES NHA_CUNG_CAP(MANCC)
);

CREATE TABLE CT_PHIEU_NHAP (
    MAPN VARCHAR(10) NOT NULL,
    MASP VARCHAR(10) NOT NULL,
    MAMAU VARCHAR(10) NOT NULL,
    MASIZE VARCHAR(10) NOT NULL,
    MACTPN AS (MAPN + MASP + MAMAU + MASIZE) PERSISTED UNIQUE,
    SOLUONG INT NOT NULL CHECK (SOLUONG > 0),
    DONGIANHAP DECIMAL(18,3) NOT NULL CHECK (DONGIANHAP >= 0),
    THANHTIEN DECIMAL(18,3) NULL,
    PRIMARY KEY (MAPN, MASP, MAMAU, MASIZE),
    FOREIGN KEY (MAPN) REFERENCES PHIEU_NHAP(MAPN),
    FOREIGN KEY (MASP, MAMAU, MASIZE) REFERENCES CHI_TIET_SP(MASP, MAMAU, MASIZE)
);

/* ===========================================================
    ĐƠN HÀNG
=========================================================== */
CREATE TABLE DON_HANG (
    MADH VARCHAR(10) PRIMARY KEY
        DEFAULT ('DH' + RIGHT('0000' + CAST(NEXT VALUE FOR SEQ_DH AS VARCHAR(10)), 4)),
    MAKH VARCHAR(10) NOT NULL,
    NGAYDAT DATE DEFAULT CAST(GETDATE() AS DATE),
    HINHTHUCTHANHTOAN NVARCHAR(50) DEFAULT N'COD',
    DIACHIGIAO NVARCHAR(200),
    GIAMGIA INT DEFAULT 0 CHECK (GIAMGIA >= 0),
    TONGSOLUONG INT DEFAULT 0 CHECK (TONGSOLUONG >= 0),
    TONGTHANHTIEN DECIMAL(18,3) DEFAULT 0 CHECK (TONGTHANHTIEN >= 0),
    TRANGTHAI BIT DEFAULT 1,
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH)
);

CREATE TABLE CT_DON_HANG (
    MADH VARCHAR(10) NOT NULL,
    MASP VARCHAR(10) NOT NULL,
    MAMAU VARCHAR(10) NOT NULL,
    MASIZE VARCHAR(10) NOT NULL,
    MACTDH AS (MADH + MASP + MAMAU + MASIZE) PERSISTED UNIQUE,
    SOLUONG INT NOT NULL CHECK (SOLUONG > 0),
    GIALUCBAN DECIMAL(18,3) NULL CHECK (GIALUCBAN IS NULL OR GIALUCBAN >= 0),
    THANHTIEN DECIMAL(18,3) NULL,
    PRIMARY KEY (MADH, MASP, MAMAU, MASIZE),
    FOREIGN KEY (MADH) REFERENCES DON_HANG(MADH),
    FOREIGN KEY (MASP, MAMAU, MASIZE) REFERENCES CHI_TIET_SP(MASP, MAMAU, MASIZE)
);
GO

/* ===========================================================
    TRIGGER: NHẬP HÀNG
    - tính thành tiền
    - cộng tồn kho CTSP
    - set giá bán = giá nhập * 1.5 (bạn có thể đổi)
    - cập nhật tổng PN
    - cập nhật tổng tồn SP
=========================================================== */
CREATE TRIGGER TG_CTPN ON CT_PHIEU_NHAP
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    -- cập nhật thành tiền dòng nhập
    UPDATE CT
    SET CT.THANHTIEN = CT.SOLUONG * CT.DONGIANHAP
    FROM CT_PHIEU_NHAP CT
    JOIN inserted I ON CT.MAPN = I.MAPN
        AND CT.MASP = I.MASP AND CT.MAMAU = I.MAMAU AND CT.MASIZE = I.MASIZE;

    -- cộng tồn kho + set giá nhập/giá bán
    UPDATE S
    SET S.SOLUONGTON = S.SOLUONGTON + I.SOLUONG,
        S.GIANHAP = I.DONGIANHAP,
        S.GIABAN  = I.DONGIANHAP * 1.5
    FROM CHI_TIET_SP S
    JOIN inserted I ON S.MASP = I.MASP
        AND S.MAMAU = I.MAMAU AND S.MASIZE = I.MASIZE;

    -- tổng phiếu nhập
    UPDATE P
    SET P.TONGSOLUONG = (SELECT SUM(SOLUONG) FROM CT_PHIEU_NHAP WHERE MAPN = P.MAPN),
        P.TONGTHANHTIEN = (SELECT SUM(THANHTIEN) FROM CT_PHIEU_NHAP WHERE MAPN = P.MAPN)
    FROM PHIEU_NHAP P
    JOIN inserted I ON P.MAPN = I.MAPN;

    -- tổng tồn kho sản phẩm
    UPDATE SP
    SET SP.SOLUONGTON = T.TONG
    FROM SAN_PHAM SP
    JOIN (
        SELECT MASP, SUM(SOLUONGTON) AS TONG
        FROM CHI_TIET_SP
        GROUP BY MASP
    ) T ON SP.MASP = T.MASP;
END
GO

/* ===========================================================
    TRIGGER: BÁN HÀNG
    - set giá lúc bán (nếu null) = giá bán CTSP
    - tính thành tiền
    - trừ tồn kho (chặn âm)
    - cập nhật tổng đơn + giảm giá theo tổng số lượng
=========================================================== */
IF OBJECT_ID('TG_CTDH', 'TR') IS NOT NULL
    DROP TRIGGER TG_CTDH;
GO

CREATE TRIGGER TG_CTDH
ON CT_DON_HANG
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    /* 1️ KIỂM TRA TỒN KHO TRƯỚC */
    IF EXISTS (
        SELECT 1
        FROM inserted I
        JOIN CHI_TIET_SP S
            ON S.MASP = I.MASP
           AND S.MAMAU = I.MAMAU
           AND S.MASIZE = I.MASIZE
        WHERE S.SOLUONGTON < I.SOLUONG
    )
    BEGIN
        RAISERROR (N'Tồn kho không đủ để bán!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END;

    /* 2️ SET GIÁ LÚC BÁN */
    UPDATE CT
    SET CT.GIALUCBAN = S.GIABAN
    FROM CT_DON_HANG CT
    JOIN inserted I
        ON CT.MADH = I.MADH
       AND CT.MASP = I.MASP
       AND CT.MAMAU = I.MAMAU
       AND CT.MASIZE = I.MASIZE
    JOIN CHI_TIET_SP S
        ON S.MASP = I.MASP
       AND S.MAMAU = I.MAMAU
       AND S.MASIZE = I.MASIZE
    WHERE CT.GIALUCBAN IS NULL;

    /* 3️ TÍNH THÀNH TIỀN */
    UPDATE CT
    SET CT.THANHTIEN = CT.SOLUONG * CT.GIALUCBAN
    FROM CT_DON_HANG CT
    JOIN inserted I
        ON CT.MADH = I.MADH
       AND CT.MASP = I.MASP
       AND CT.MAMAU = I.MAMAU
       AND CT.MASIZE = I.MASIZE;

    /* 4️ TRỪ TỒN KHO */
    UPDATE S
    SET S.SOLUONGTON = S.SOLUONGTON - I.SOLUONG
    FROM CHI_TIET_SP S
    JOIN inserted I
        ON S.MASP = I.MASP
       AND S.MAMAU = I.MAMAU
       AND S.MASIZE = I.MASIZE;

    /* 5️ CẬP NHẬT ĐƠN HÀNG */
    UPDATE D
    SET
        D.TONGSOLUONG = (
            SELECT SUM(SOLUONG)
            FROM CT_DON_HANG
            WHERE MADH = D.MADH
        ),
        D.GIAMGIA = CASE
            WHEN (SELECT SUM(SOLUONG) FROM CT_DON_HANG WHERE MADH = D.MADH) >= 10 THEN 7
            WHEN (SELECT SUM(SOLUONG) FROM CT_DON_HANG WHERE MADH = D.MADH) >= 5 THEN 5
            ELSE 0
        END,
        D.TONGTHANHTIEN =
            (SELECT SUM(THANHTIEN) FROM CT_DON_HANG WHERE MADH = D.MADH)
            * (1 - (
                CASE
                    WHEN (SELECT SUM(SOLUONG) FROM CT_DON_HANG WHERE MADH = D.MADH) >= 10 THEN 7
                    WHEN (SELECT SUM(SOLUONG) FROM CT_DON_HANG WHERE MADH = D.MADH) >= 5 THEN 5
                    ELSE 0
                END
            ) / 100.0)
    FROM DON_HANG D
    JOIN inserted I ON D.MADH = I.MADH;

    /* 6️ UPDATE TỔNG TỒN SP */
    UPDATE SP
    SET SP.SOLUONGTON = T.TONG
    FROM SAN_PHAM SP
    JOIN (
        SELECT MASP, SUM(SOLUONGTON) AS TONG
        FROM CHI_TIET_SP
        GROUP BY MASP
    ) T ON SP.MASP = T.MASP;
END;
GO

/* ===========================================================
    STORED PROCEDURE: ĐĂNG KÝ / ĐĂNG NHẬP / SEARCH / DM
=========================================================== */
GO
CREATE PROCEDURE SP_DANGKY
    @USER VARCHAR(50), @PASS VARCHAR(200),
    @HOTEN NVARCHAR(200), @EMAIL NVARCHAR(200), @SDT VARCHAR(15), @DIACHI NVARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    -- tạo tài khoản user
    INSERT INTO TAI_KHOAN(USERNAME, MATKHAU, MAVT, TRANGTHAI)
    VALUES (@USER, @PASS, 'VT02', 1);

    -- tạo khách hàng link theo USERNAME
    INSERT INTO KHACH_HANG(USERNAME, HOTEN, SDT, EMAIL, DIACHI, TRANGTHAI)
    VALUES (@USER, @HOTEN, @SDT, @EMAIL, @DIACHI, 1);
END
GO

CREATE PROCEDURE SP_DANGNHAP
    @USER VARCHAR(50), @PASS VARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT TK.USERNAME, VT.TENVAI
    FROM TAI_KHOAN TK
    JOIN VAI_TRO VT ON TK.MAVT = VT.MAVT
    WHERE TK.USERNAME = @USER AND TK.MATKHAU = @PASS AND TK.TRANGTHAI = 1;
END
GO

CREATE PROCEDURE SP_SP_TIMKIEM @KEY NVARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MASP, TENSP, SOLUONGTON
    FROM SAN_PHAM
    WHERE TENSP LIKE N'%' + @KEY + N'%';
END
GO

CREATE PROCEDURE SP_DM_LIST
AS
BEGIN
    SET NOCOUNT ON;
    SELECT DM.*, NDM.TENNHOM
    FROM DANH_MUC DM
    JOIN NHOM_DANH_MUC NDM ON DM.MANHOM = NDM.MANHOM;
END
GO

CREATE PROCEDURE SP_DM_ADD @TEN NVARCHAR(100), @MANHOM VARCHAR(10)
AS
BEGIN
    INSERT INTO DANH_MUC(TENDM, MANHOM) VALUES(@TEN, @MANHOM);
END
GO

CREATE PROCEDURE SP_DM_UPDATE @MADM VARCHAR(10), @TEN NVARCHAR(100), @MANHOM VARCHAR(10), @TT BIT
AS
BEGIN
    UPDATE DANH_MUC SET TENDM=@TEN, MANHOM=@MANHOM, TRANGTHAI=@TT WHERE MADM=@MADM;
END
GO

CREATE PROCEDURE SP_DM_DELETE @MADM VARCHAR(10)
AS
BEGIN
    IF EXISTS(SELECT 1 FROM SAN_PHAM WHERE MADM=@MADM)
        UPDATE DANH_MUC SET TRANGTHAI=0 WHERE MADM=@MADM;
    ELSE
        DELETE FROM DANH_MUC WHERE MADM=@MADM;
END
GO

-- 1) Vai trò
INSERT INTO VAI_TRO(MAVT, TENVAI) VALUES
('VT01', N'admin'),
('VT02', N'user');

-- 2) Tài khoản
INSERT INTO TAI_KHOAN(USERNAME, MATKHAU, MAVT, TRANGTHAI) VALUES
('admin','123456','VT01',1),
('Nguyen1235','12345678','VT02',1),
('PhatHuy','12345678','VT02',1),
('user01','123456','VT02',1),
('user02','123456','VT02',1),
('user03','123456','VT02',1),
('user04','123456','VT02',1),
('user05','123456','VT02',1),
('user06','123456','VT02',1),
('user07','123456','VT02',1),
('user08','123456','VT02',1),
('user09','123456','VT02',1),
('user10','123456','VT02',1);
GO


-- 3) Khách hàng (link USERNAME -> TAI_KHOAN)
INSERT INTO KHACH_HANG(MAKH,USERNAME,HOTEN,SDT,EMAIL,DIACHI,TRANGTHAI) VALUES
('KH0001','user01',N'Lê Minh Thảo','0903111222','thaole@gmail.com',N'Q1, HCM',1),
('KH0002','user02',N'Nguyễn Thái Hòa','0912333444','hoa.nt@gmail.com',N'Q3, HCM',1),
('KH0003','user03',N'Trần Thị Mai','0933444555','maitran@gmail.com',N'Tân Bình, HCM',1),
('KH0004','user04',N'Phạm Nhật Tân','0988777666','tanpnhat@gmail.com',N'Bình Thạnh, HCM',1),
('KH0005','user05',N'Võ Anh Quân','0902555666','quan.vo@gmail.com',N'Thủ Đức, HCM',1),
('KH0006','user06',N'Đỗ Hoàng Vy','0966778899','vy.do@gmail.com',N'Hà Nội',1),
('KH0007','user07',N'Nguyễn Ngọc Hà','0911888999','hanguyen@gmail.com',N'Hà Nội',1),
('KH0008','user08',N'Phan Thùy Trang','0937788996','trangpth@gmail.com',N'Đà Nẵng',1),
('KH0009','user09',N'Vũ Minh Khoa','0988555444','khoa.vu@gmail.com',N'Hải Phòng',1),
('KH0010','user10',N'Huỳnh Gia Hân','0909777333','hanh.huynh@gmail.com',N'Cần Thơ',1),
('KH0011','Nguyen1235',N'Huỳnh Nguyên','0907766198','nguyenhuynh120305@gmail.com',N'HCM',1),
('KH0012','PhatHuy',N'Phát Huy','0912345678','huy@gmail.com',N'HCM',1);
GO

-- 4) Nhóm danh mục
INSERT INTO NHOM_DANH_MUC(MANHOM, TENNHOM) VALUES
('NDM01', N'Áo'),
('NDM02', N'Quần'),
('NDM03', N'Váy / Đầm'),
('NDM04', N'Khác');

-- 5) Danh mục (mỗi nhóm có nhiều danh mục)
INSERT INTO DANH_MUC(MADM, TENDM, MANHOM) VALUES
('DM01', N'Áo thun', 'NDM01'),
('DM02', N'Sơ mi',  'NDM01'),
('DM03', N'Hoodie', 'NDM01'),
('DM04', N'Áo khoác','NDM01'),
('DM05', N'Quần jean','NDM02'),
('DM06', N'Quần short','NDM02'),
('DM07', N'Chân váy','NDM03'),
('DM08', N'Đầm', 'NDM03'),
('DM09', N'Đồ ngủ', 'NDM04'),
('DM10', N'Yếm denim', 'NDM04');

-- 6) Màu, Size
INSERT INTO MAU_SAC(MAMAU, TENMAU) VALUES 
('M01', N'Đen'),
('M02', N'Trắng'),
('M03', N'Kem');

INSERT INTO KICH_THUOC(MASIZE, TENSIZE) VALUES
('SZ01', N'S'),
('SZ02', N'M'),
('SZ03', N'L');

-- 7) Sản phẩm
INSERT INTO SAN_PHAM VALUES
('SP001',N'Áo thun basic cotton','DM01',N'Cotton form rộng',1260,1),
('SP002',N'Áo sơ mi tay dài nữ','DM02',N'Áo thun mát lạnh',1134,1),
('SP003',N'Hoodie oversize nữ','DM03',N'Nỉ bông',972,1),
('SP004',N'Áo khoác bomber nữ','DM04',N'Kaki mềm',1013,1),
('SP005',N'Quần jean skinny nữ','DM05',N'Co giãn 4 chiều',981,1),
('SP006',N'Quần short kaki nữ','DM06',N'Kaki co giãn',1166,1),
('SP007',N'Chân váy chữ A','DM07',N'Dáng A, tuyết mưa',1002,1),
('SP008',N'Đầm công sở body','DM08',N'Body sang trọng',1078,1),
('SP009',N'Đồ ngủ pijama nữ','DM09',N'Cotton mềm',1014,1),
('SP010',N'Yếm váy denim nữ','DM10',N'Denim cá tính',970,1),
('SP011',N'Áo thun nữ basic form rộng','DM01',N'Cotton 100%',150,1),
('SP012',N'Áo thun nữ cổ tròn','DM01',N'Mềm, thoáng mát',120,1),
('SP013',N'Áo thun nữ in chữ','DM01',N'Phong cách trẻ trung',90,1),
('SP014',N'Sơ mi nữ tay dài công sở','DM02',N'Lụa mềm',75,1),
('SP015',N'Sơ mi nữ form rộng','DM02',N'Phong cách Hàn',60,1),
('SP016',N'Sơ mi nữ cổ bèo','DM02',N'Nữ tính',90,1),
('SP017',N'Hoodie nữ oversize','DM03',N'Nỉ bông',105,1),
('SP018',N'Hoodie nữ trơn','DM03',N'Hoddie giữ ấm đêm đông',90,1),
('SP019',N'Hoodie nữ có mũ','DM03',N'Phong cách street',60,0);
GO

select * from HINH_ANH_SP
-- 8) Hình ảnh (demo)
DECLARE @MASP VARCHAR(10), @i INT;
DECLARE cur CURSOR FOR SELECT MASP FROM SAN_PHAM;
OPEN cur;
FETCH NEXT FROM cur INTO @MASP;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @i = 1;
    WHILE @i <= 3
    BEGIN
        INSERT INTO HINH_ANH_SP(MASP, TENHINHANH, TRANGTHAI)
        VALUES (@MASP, LOWER(@MASP)+'_'+CAST(@i AS VARCHAR)+'.jpg',1);
        SET @i += 1;
    END
    FETCH NEXT FROM cur INTO @MASP;
END
CLOSE cur;
DEALLOCATE cur;
GO


-- 9) Tạo biến thể CTSP (10 sp x 3 màu x 3 size = 90 dòng)
;WITH P AS (
    SELECT MASP FROM SAN_PHAM
), C AS (
    SELECT MAMAU FROM MAU_SAC
), Z AS (
    SELECT MASIZE FROM KICH_THUOC
)
INSERT INTO CHI_TIET_SP(MASP, MAMAU, MASIZE, SOLUONGTON)
SELECT P.MASP, C.MAMAU, Z.MASIZE, 0
FROM P CROSS JOIN C CROSS JOIN Z;

-- BỔ SUNG TỒN KHO CHO TẤT CẢ BIẾN THỂ CHƯA NHẬP
UPDATE CHI_TIET_SP
SET SOLUONGTON = 100,
    GIANHAP = ISNULL(GIANHAP, 300000),
    GIABAN  = ISNULL(GIABAN, 450000)
WHERE SOLUONGTON = 0;


-- 10) Nhà cung cấp + phiếu nhập
INSERT INTO NHA_CUNG_CAP(MANCC, TENNCC, SDT, DIACHI) VALUES
('NCC01', N'Fashion Supplier', '0988001122', N'Hà Nội'),
('NCC02', N'Saigon Clothes Co', '0909123456', N'HCM');

INSERT INTO PHIEU_NHAP(MAPN, MANCC, NGAYLAP, TONGSOLUONG, TONGTHANHTIEN, GHICHU, TRANGTHAI) VALUES
('PN0001','NCC01','2025-12-21',721,255565000,N'Nhập đầu kho',1),
('PN0002','NCC01','2025-12-21',378,163020000,N'Nhập bổ sung',1),
('PN0003','NCC02','2025-12-21',344,170150000,N'Nhập hàng đợt 3',1),
('PN0004','NCC02','2025-12-21',194,88350000,N'Nhập hàng Tết',1),
('PN0005','NCC01','2025-12-24',840,347650000,N'Nhập hàng cho SP011–SP019',1);
GO


-- 11) Chi tiết phiếu nhập (trigger TG_CTPN sẽ tự cộng tồn & set giá)
INSERT INTO CT_PHIEU_NHAP(MAPN, MASP, MAMAU, MASIZE, SOLUONG, DONGIANHAP, THANHTIEN) VALUES
('PN0001','SP001','M01','SZ01',50,300000,NULL),
('PN0001','SP001','M01','SZ02',40,320000,NULL),
('PN0001','SP001','M01','SZ03',35,310000,NULL),
('PN0001','SP001','M02','SZ01',45,330000,NULL),
('PN0001','SP001','M02','SZ02',40,315000,NULL),
('PN0001','SP001','M02','SZ03',30,305000,NULL),
('PN0001','SP001','M03','SZ01',50,300000,NULL),
('PN0001','SP001','M03','SZ02',45,340000,NULL),
('PN0001','SP001','M03','SZ03',38,350000,NULL),

('PN0001','SP002','M01','SZ01',30,400000,NULL),
('PN0001','SP002','M01','SZ02',25,420000,NULL),
('PN0001','SP002','M01','SZ03',20,430000,NULL),
('PN0001','SP002','M02','SZ01',28,410000,NULL),
('PN0001','SP002','M02','SZ02',26,435000,NULL),
('PN0001','SP002','M02','SZ03',24,445000,NULL),
('PN0001','SP002','M03','SZ01',32,380000,NULL),
('PN0001','SP002','M03','SZ02',30,390000,NULL),
('PN0001','SP002','M03','SZ03',28,395000,NULL),

('PN0001','SP007','M01','SZ01',40,350000,NULL),
('PN0001','SP007','M01','SZ02',35,355000,NULL),
('PN0001','SP007','M01','SZ03',30,360000,NULL);

INSERT INTO CT_PHIEU_NHAP(MAPN, MASP, MAMAU, MASIZE, SOLUONG, DONGIANHAP, THANHTIEN) VALUES
('PN0002','SP008','M02','SZ02',36,380000,NULL),
('PN0002','SP008','M02','SZ03',34,390000,NULL),
('PN0002','SP008','M03','SZ01',40,400000,NULL),
('PN0002','SP008','M03','SZ02',35,395000,NULL),
('PN0002','SP008','M03','SZ03',33,405000,NULL),

('PN0002','SP004','M01','SZ01',20,500000,NULL),
('PN0002','SP004','M01','SZ02',18,520000,NULL),
('PN0002','SP004','M01','SZ03',16,540000,NULL),
('PN0002','SP004','M02','SZ01',22,550000,NULL),
('PN0002','SP004','M02','SZ02',20,560000,NULL),
('PN0002','SP004','M02','SZ03',19,580000,NULL),

('PN0002','SP005','M01','SZ01',30,350000,NULL),
('PN0002','SP005','M01','SZ02',28,360000,NULL),
('PN0002','SP005','M01','SZ03',27,370000,NULL);

INSERT INTO CT_PHIEU_NHAP(MAPN, MASP, MAMAU, MASIZE, SOLUONG, DONGIANHAP, THANHTIEN) VALUES
('PN0003','SP006','M01','SZ01',45,420000,NULL),
('PN0003','SP006','M01','SZ02',42,430000,NULL),
('PN0003','SP006','M01','SZ03',40,440000,NULL),
('PN0003','SP006','M02','SZ01',48,450000,NULL),
('PN0003','SP006','M02','SZ02',44,460000,NULL),
('PN0003','SP006','M03','SZ01',50,480000,NULL),

('PN0003','SP003','M01','SZ01',25,600000,NULL),
('PN0003','SP003','M02','SZ02',25,670000,NULL),
('PN0003','SP003','M03','SZ03',25,720000,NULL);

INSERT INTO CT_PHIEU_NHAP(MAPN, MASP, MAMAU, MASIZE, SOLUONG, DONGIANHAP, THANHTIEN) VALUES
('PN0004','SP009','M01','SZ01',40,320000,NULL),
('PN0004','SP009','M02','SZ02',40,360000,NULL),
('PN0004','SP009','M03','SZ03',40,400000,NULL),

('PN0004','SP010','M01','SZ01',25,550000,NULL),
('PN0004','SP010','M02','SZ02',24,600000,NULL),
('PN0004','SP010','M03','SZ03',25,680000,NULL);

-- 12) Đơn hàng (20 đơn như hồi nãy)
INSERT INTO DON_HANG(MADH, MAKH, DIACHIGIAO, HINHTHUCTHANHTOAN) VALUES
('DH0001','KH0002', N'Q1, HCM', N'COD'),
('DH0002','KH0003', N'Q3, HCM', N'BANK'),
('DH0003','KH0004', N'Tân Bình, HCM', N'CASH'),
('DH0004','KH0005', N'Bình Thạnh, HCM', N'COD'),
('DH0005','KH0006', N'Thủ Đức, HCM', N'COD'),
('DH0006','KH0007', N'Hà Nội', N'BANK'),
('DH0007','KH0008', N'Hà Nội', N'CASH'),
('DH0008','KH0009', N'Đà Nẵng', N'COD'),
('DH0009','KH0010', N'Hải Phòng', N'CASH'),
('DH0010','KH0010', N'Cần Thơ', N'COD'),
('DH0011','KH0002', N'Q1, HCM', N'COD'),
('DH0012','KH0003', N'Q3, HCM', N'BANK'),
('DH0013','KH0004', N'Tân Bình, HCM', N'COD'),
('DH0014','KH0005', N'Bình Thạnh, HCM', N'CASH'),
('DH0015','KH0006', N'Thủ Đức, HCM', N'COD'),
('DH0016','KH0007', N'Hà Nội', N'BANK'),
('DH0017','KH0008', N'Hà Nội', N'CASH'),
('DH0018','KH0009', N'Đà Nẵng', N'COD')


-- 13) CT đơn hàng (trigger TG_CTDH tự set giá, tính tiền, trừ kho, cập nhật tổng)
INSERT INTO CT_DON_HANG(MADH, MASP, MAMAU, MASIZE, SOLUONG) VALUES
('DH0001','SP001','M01','SZ01',2),
('DH0001','SP001','M02','SZ02',1),
('DH0002','SP002','M03','SZ01',1),
('DH0002','SP007','M01','SZ02',2),
('DH0003','SP004','M02','SZ03',1),
('DH0003','SP005','M01','SZ01',2),
('DH0004','SP006','M02','SZ01',1),
('DH0004','SP003','M03','SZ03',2),
('DH0005','SP009','M01','SZ02',3),
('DH0005','SP010','M02','SZ01',1),
('DH0006','SP010','M03','SZ02',2),
('DH0006','SP001','M01','SZ03',1),
('DH0007','SP002','M02','SZ02',2),
('DH0007','SP007','M03','SZ01',1),
('DH0008','SP004','M01','SZ03',1),
('DH0008','SP005','M02','SZ01',2),
('DH0009','SP006','M03','SZ02',2),
('DH0009','SP003','M01','SZ01',1),
('DH0010','SP009','M02','SZ02',3),
('DH0010','SP010','M03','SZ03',1);

GO

/* ===========================================================
    RESTART SEQUENCE để tránh trùng mã do ta insert mã thủ công
=========================================================== */
ALTER SEQUENCE SEQ_VT   RESTART WITH 3;
ALTER SEQUENCE SEQ_NDM  RESTART WITH 5;
ALTER SEQUENCE SEQ_DM   RESTART WITH 11;
ALTER SEQUENCE SEQ_MAU  RESTART WITH 4;
ALTER SEQUENCE SEQ_SIZE RESTART WITH 4;
ALTER SEQUENCE SEQ_SP   RESTART WITH 20;
ALTER SEQUENCE SEQ_HINH RESTART WITH 58;
ALTER SEQUENCE SEQ_NCC  RESTART WITH 3;
ALTER SEQUENCE SEQ_PN   RESTART WITH 5;
ALTER SEQUENCE SEQ_KH   RESTART WITH 13;
ALTER SEQUENCE SEQ_DH   RESTART WITH 19;
GO

/* ===========================================================
    QUICK CHECK (tuỳ chọn)
=========================================================== */
-- SELECT TOP 5 * FROM NHOM_DANH_MUC;
-- SELECT TOP 5 * FROM DANH_MUC;
-- SELECT TOP 5 * FROM SAN_PHAM;
-- SELECT TOP 5 * FROM CHI_TIET_SP ORDER BY MASP;
-- SELECT TOP 5 * FROM PHIEU_NHAP;
-- SELECT TOP 5 * FROM DON_HANG;
GO


--Stored Proceduce
CREATE PROCEDURE SP_NHOMDM_ADD
    @TENNHOM NVARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO NHOM_DANH_MUC(TENNHOM)
    VALUES (@TENNHOM);
END
GO


CREATE PROCEDURE SP_DANHMUC_ADD
    @TENDM NVARCHAR(100),
    @MANHOM VARCHAR(10)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO DANH_MUC(TENDM, MANHOM)
    VALUES (@TENDM, @MANHOM);
END
GO


CREATE PROCEDURE SP_SANPHAM_ADD
    @TENSP NVARCHAR(200),
    @MADM VARCHAR(10),
    @MOTA NVARCHAR(MAX)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO SAN_PHAM(TENSP, MADM, MOTA)
    VALUES (@TENSP, @MADM, @MOTA);
END
GO


CREATE PROCEDURE SP_CTSP_INIT
    @MASP VARCHAR(10)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO CHI_TIET_SP(MASP, MAMAU, MASIZE, SOLUONGTON)
    SELECT @MASP, M.MAMAU, S.MASIZE, 0
    FROM MAU_SAC M
    CROSS JOIN KICH_THUOC S;
END
GO


CREATE PROCEDURE SP_NCC_ADD
    @TENNCC NVARCHAR(200),
    @SDT VARCHAR(15),
    @DIACHI NVARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO NHA_CUNG_CAP(TENNCC, SDT, DIACHI)
    VALUES (@TENNCC, @SDT, @DIACHI);
END
GO


CREATE PROCEDURE SP_PHIEUNHAP_CREATE
    @MANCC VARCHAR(10),
    @GHICHU NVARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO PHIEU_NHAP(MANCC, GHICHU)
    VALUES (@MANCC, @GHICHU);

    SELECT SCOPE_IDENTITY(); -- optional
END
GO

CREATE PROCEDURE SP_CTPN_ADD
    @MAPN VARCHAR(10),
    @MASP VARCHAR(10),
    @MAMAU VARCHAR(10),
    @MASIZE VARCHAR(10),
    @SOLUONG INT,
    @DONGIANHAP DECIMAL(18,3)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO CT_PHIEU_NHAP
        (MAPN, MASP, MAMAU, MASIZE, SOLUONG, DONGIANHAP)
    VALUES
        (@MAPN, @MASP, @MAMAU, @MASIZE, @SOLUONG, @DONGIANHAP);
END
GO


CREATE PROCEDURE SP_DONHANG_CREATE
    @MAKH VARCHAR(10),
    @DIACHIGIAO NVARCHAR(255),
    @HINHTHUCTT VARCHAR(10),
    @MADH VARCHAR(10) OUTPUT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @So INT = NEXT VALUE FOR SEQ_DH;

    SET @MADH = 'DH' + RIGHT('0000' + CAST(@So AS VARCHAR), 4);

    INSERT INTO DON_HANG (
        MADH,
        MAKH,
        NGAYDAT,
        DIACHIGIAO,
        HINHTHUCTHANHTOAN
    )
    VALUES (
        @MADH,
        @MAKH,
        GETDATE(),
        @DIACHIGIAO,
        @HINHTHUCTT
    );
END
GO

CREATE PROCEDURE SP_CTDH_ADD
    @MADH VARCHAR(10),
    @MASP VARCHAR(10),
    @MAMAU VARCHAR(10),
    @MASIZE VARCHAR(10),
    @SOLUONG INT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO CT_DON_HANG
        (MADH, MASP, MAMAU, MASIZE, SOLUONG)
    VALUES
        (@MADH, @MASP, @MAMAU, @MASIZE, @SOLUONG);
END
GO
